name: Restore dotnet packages
description: Restores dotnet packages including privates ones

inputs:
  packageReadonlyPat:
    description: "Personal access token used to access the github private nuget source."
    required: true
  dotnetVersion:
    description: "Version of dotnet to use."
    required: true

runs:
  using: "composite"
  steps:

    - name: .NET Install
      env:
        DOTNET_INSTALL_DIR: "./.dotnet"  # Required by the runner to install dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ inputs.dotnetVersion }}

    - name: Ensure Trakx GitHub Packages source exists and has credentials
      shell: bash
      env:
        PACKAGE_READONLY_PAT: ${{ inputs.packageReadonlyPat }}
      run: |
        set -euo pipefail

        FEED_URL="https://nuget.pkg.github.com/trakx/index.json"
        FEED_FALLBACK_NAME="github"
        FEED_USERNAME="trakx-bot"

        get_nuget_source_name_by_url() {
          local source_url="$1"
          dotnet nuget list source \
            | awk -v url="$source_url" '
                match($0, /^[[:space:]]*[0-9]+[.][[:space:]]*(.+)[[:space:]]+\[(Enabled|Disabled)\][[:space:]]*$/, m) {
                  name=m[1]
                  status=m[2]
                  next
                }
                index($0, url) && status=="Enabled" {
                  print name
                  exit
                }
              '
        }

        FEED_NAME="$(get_nuget_source_name_by_url "$FEED_URL" || true)"

        if [ -n "${FEED_NAME:-}" ]; then
          echo "GitHub feed already configured as '$FEED_NAME'. Updating credentials."
          echo "ADDED_GITHUB_SOURCE=false" >> "$GITHUB_ENV"

          dotnet nuget update source "$FEED_NAME" \
            --username "$FEED_USERNAME" \
            --password "$PACKAGE_READONLY_PAT" \
            --store-password-in-clear-text
        else
          echo "GitHub feed not configured. Adding as '$FEED_FALLBACK_NAME'."
          echo "ADDED_GITHUB_SOURCE=true" >> "$GITHUB_ENV"

          dotnet nuget add source "$FEED_URL" \
            --name "$FEED_FALLBACK_NAME" \
            --username "$FEED_USERNAME" \
            --password "$PACKAGE_READONLY_PAT" \
            --store-password-in-clear-text
        fi

    - name: Restore Cache
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('packages.lock.json', '*/packages.lock.json') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: .NET Restore packages
      shell: bash
      env:
        DOTNET_NUGET_SIGNATURE_VERIFICATION: false
        NUGET_AUTH_TOKEN: ${{ inputs.packageReadonlyPat }}
      run: dotnet restore --locked-mode

    - name: Remove Trakx github source (only if action added it)
      if: env.ADDED_GITHUB_SOURCE == 'true'
      shell: bash
      run: dotnet nuget remove source "github" || true