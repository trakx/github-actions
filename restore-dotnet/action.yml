name: Restore dotnet packages
description: Restores dotnet packages including privates ones

inputs:
  packageReadonlyPat:
    description: "Personal access token used to access the github private nuget source."
    required: true
  dotnetVersion:
    description: "Version of dotnet to use."
    required: true

runs:
  using: "composite"
  steps:

    - name: .NET Install
      env:
        DOTNET_INSTALL_DIR: "./.dotnet"  # Required by the runner to install dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ inputs.dotnetVersion }}

    - name: Ensure Trakx github nuget source exists (only if missing)
      shell: bash
      run: |
        set -euo pipefail

        FEED_NAME="github"
        FEED_URL="https://nuget.pkg.github.com/trakx/index.json"

        if dotnet nuget list source --format Short | awk '{print $2}' | grep -qxF "$FEED_URL"; then
          echo "GitHub Packages feed already configured ($FEED_URL)."
          echo "ADDED_GITHUB_SOURCE=false" >> "$GITHUB_ENV"
        else
          echo "Adding GitHub Packages feed as '$FEED_NAME' ($FEED_URL)."
          dotnet nuget add source "$FEED_URL" --name "$FEED_NAME"
          echo "ADDED_GITHUB_SOURCE=true" >> "$GITHUB_ENV"
        fi

    - name: Restore Cache
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('packages.lock.json', '*/packages.lock.json') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: .NET Restore packages
      shell: bash
      env:
        DOTNET_NUGET_SIGNATURE_VERIFICATION: false
        NUGET_AUTH_TOKEN: ${{ inputs.packageReadonlyPat }}
      run: dotnet restore --locked-mode

    - name: Remove Trakx github source (only if action added it)
      if: env.ADDED_GITHUB_SOURCE == 'true'
      shell: bash
      run: dotnet nuget remove source "github" || true